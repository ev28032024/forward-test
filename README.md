# Forward Monitor

#### Лёгкий мост между Discord и Telegram.

## Установка
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -e .[dev]
```

## Запуск
1. Получите токен Telegram-бота у BotFather.
2. Запустите монитор:
   ```bash
   export FORWARD_TELEGRAM_TOKEN="123:ABC"
   python -m forward_monitor --db-path forward.db
   ```
3. Откройте чат с ботом и отправьте `/start`, затем `/claim`, чтобы назначить себя администратором.
4. Настраивайте каналы и параметры командами (см. ниже).

> **Примечание.** Токен Discord задаётся из Telegram командой `/set_discord_token`. До этого момента мост не будет опрашивать каналы.

## Основные команды
Команды вводятся в чате с ботом. В скобках указано, нужно ли быть администратором.

### Общие
- `/start` — короткое приветствие (без прав).
- `/help` — структурированная справка по командам (без прав).
- `/status` — сводка по токену, сети, оформлению и каналам (без прав).

### Администрирование
- `/claim` — стать первым администратором (без прав, если список пуст).
- `/admins` — показать текущих администраторов (админ).
- `/grant <id|@user>` — выдать права (админ).
- `/revoke <id|@user>` — отозвать права (админ).

### Каналы
- `/add_channel <discord_id> <telegram_chat[:thread]> <название> [messages|pinned]` — создать связку, задать видимое имя и сразу выбрать режим мониторинга (админ).
- `/remove_channel <discord_id>` — удалить связку (админ).
- `/list_channels` — список активных связок (админ).

### Подключение и режим работы
- `/set_discord_token <token>` — сохранить токен Discord (админ).
- `/set_proxy <url|clear> [логин] [пароль]` — настроить или отключить прокси для Discord (админ).
- `/set_user_agent <строка>` — указать пользовательский User-Agent (админ).
- `/set_poll <секунды>` — период опроса Discord (админ).
- `/set_delay <min_ms> <max_ms>` — случайная пауза между сообщениями (админ).
- `/set_rate <в_секунду>` — общий предел запросов (админ).
- `/set_duplicate_filter <discord_id|all> <on|off>` — включить или выключить фильтр дубликатов глобально или для конкретного канала (админ).

### Оформление и фильтры
- `/set_disable_preview <discord_id|all> <on|off>` — управлять предпросмотром ссылок (админ).
- `/set_max_length <discord_id|all> <число>` — ограничить длину сообщения и разбивать текст (админ).
- `/set_attachments <discord_id|all> <summary|links>` — выбрать стиль блока вложений (админ).
- `/set_monitoring <discord_id|all> <messages|pinned>` — выбрать режим мониторинга (новые или закреплённые сообщения) (админ).
- `/add_filter <discord_id|all> <тип> <значение>` — добавить фильтр (`whitelist`, `blacklist`, `allowed_senders`, `blocked_senders`, `allowed_types`, `blocked_types`, `allowed_roles`, `blocked_roles`) (админ).
- `/clear_filter <discord_id|all> <тип> [значение]` — очистить фильтр целиком или по значению (админ).

Команды `all` или `*` на месте идентификатора канала меняют глобальные значения для всех связок, а идентификатор `0` служит для глобальных фильтров.

## Схема работы
1. Бот Telegram принимает команды и сохраняет настройки в локальную SQLite-базу.
2. Монитор регулярно опрашивает указанные Discord-каналы, применяет фильтры и преобразования.
3. Сообщения отправляются в Telegram с учётом настроек.

## Тесты и проверка
Для разработки установите инструменты и подготовьте git-hooks:

```bash
pip install -U ruff mypy pytest pytest-asyncio aresponses pre-commit
pre-commit install
```

Полный прогон локального CI выполняется командой:

```bash
make ci
```

Она включает три слоя проверок:

- **Ruff** — стиль и ошибки импортов. Если проверка падает, отсортируйте импорты и приведите строки к лимиту 100 символов.
- **mypy** — статическая типизация. Добавляйте точные типы, `TypedDict` или `Protocol`; избегайте `# type: ignore` без крайней необходимости.
- **pytest** — функциональные тесты. Исправляйте причину сбоя в коде, а не отключайте тесты.

Hook `pre-commit` добавляет проверку `pytest -q` перед push, поэтому держите тесты зелёными. **Правило проекта: не сливать изменения, пока `make ci` не проходит.**
